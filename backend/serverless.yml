service: taskflow-backend

frameworkVersion: "3"

provider:
  name: aws
  runtime: python3.11
  region: eu-west-1
  stage: ${opt:stage, 'dev'}

  architecture: arm64
  environment:
    DYNAMODB_TABLE_NAME: ${self:service}-${self:provider.stage}-table
    REPORTS_TABLE: ${self:service}-${self:provider.stage}-reports
    USER_PROJECT_TABLE: ${self:service}-${self:provider.stage}-user-projects
    REPORTS_BUCKET: ${self:service}-${self:provider.stage}-reports
    KB_TABLE_NAME: ${self:service}-${self:provider.stage}-knowledge-bases
    DOCS_TABLE_NAME: ${self:service}-${self:provider.stage}-documents
    CONVERSATIONS_TABLE: ${self:service}-${self:provider.stage}-conversations
    KB_BUCKET_NAME: ${self:service}-${self:provider.stage}-kb
    INDEXING_QUEUE_URL:
      Ref: KnowledgeBaseIndexingQueue
    TWILIO_PARAMETER_PATH: /mabani/twilio
    BEDROCK_MODEL_ID: eu.amazon.nova-lite-v1:0
    BEDROCK_VISION_MODEL_ID: eu.amazon.nova-pro-v1:0
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
    FILE_PROCESSING_BUCKET: almabanistack-almabanidataf54b245b-big4a9rsdgn2
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-table"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-table/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-reports"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-reports/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-user-projects"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-knowledge-bases"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-knowledge-bases/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-documents"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-documents/index/*"
            - "arn:aws:dynamodb:${self:provider.region}:*:table/${self:service}-${self:provider.stage}-conversations"
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:PutObjectTagging
            - s3:DeleteObject
            - s3:ListBucket
          Resource:
            - "arn:aws:s3:::${self:service}-${self:provider.stage}-reports"
            - "arn:aws:s3:::${self:service}-${self:provider.stage}-reports/*"
            - "arn:aws:s3:::${self:service}-${self:provider.stage}-kb"
            - "arn:aws:s3:::${self:service}-${self:provider.stage}-kb/*"
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
            - ssm:GetParametersByPath
          Resource:
            - "arn:aws:ssm:${self:provider.region}:*:parameter/mabani/twilio/*"
            - "arn:aws:ssm:${self:provider.region}:*:parameter/mabani/twilio"
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
          Resource:
            - "arn:aws:bedrock:*::foundation-model/*"
            - "arn:aws:bedrock:*:*:inference-profile/*"
            - "arn:aws:bedrock:*:*:knowledge-base/*" # Allow querying Knowledge Bases
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
          Resource:
            - { "Fn::GetAtt": ["KnowledgeBaseIndexingQueue", "Arn"] }
            - { "Fn::GetAtt": ["KnowledgeBaseIndexingDLQ", "Arn"] }
        - Effect: Allow
          Action:
            - states:StartExecution
          Resource:
            - "arn:aws:states:${self:provider.region}:*:stateMachine:${self:service}-${self:provider.stage}-report-workflow"
        - Effect: Allow
          Action:
            - lambda:InvokeFunction
          Resource:
            - "arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-reportProcessor"
            - "arn:aws:lambda:${self:provider.region}:*:function:${self:service}-${self:provider.stage}-workflowWorker"
        - Effect: Allow
          Action:
            - textract:DetectDocumentText
            - textract:StartDocumentTextDetection
            - textract:GetDocumentTextDetection
          Resource: "*"
        - Effect: Allow
          Action:
            - s3:ListBucket
            - s3:GetObject
            - s3:PutObject
          Resource:
            - "arn:aws:s3:::${self:provider.environment.FILE_PROCESSING_BUCKET}"
            - "arn:aws:s3:::${self:provider.environment.FILE_PROCESSING_BUCKET}/*"

plugins:
  - serverless-python-requirements
  - serverless-offline

custom:
  pythonRequirements:
    dockerizePip: non-linux # Force Docker for all builds (including macOS)
    dockerImage: public.ecr.aws/sam/build-python3.11:latest # Use AWS SAM build image for Python 3.11
    layer: true # Create Python requirements layer
    slim: true
    noDeploy:
      - boto3
      - botocore
      - pytest
      - pytest-mock
    # Note: numpy and faiss-cpu are included in the layer for the indexing worker
    # They are large but necessary for FAISS vector operations
    # pydantic_core will be built for Linux inside Docker
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
    noPrependStageInUrl: true
    skipCacheInvalidation: false
    useChildProcesses: false
    enforceSecureCookies: false
    # Workaround for Python 3.13: Use Docker to bypass runtime version check
    useDocker: true
    noDeps:
      - boto3
      - botocore

layers:
  sharedCode:
    path: layers/shared
    name: ${self:service}-${self:provider.stage}-shared-code
    description: Common shared code for Lambda functions (lambda_helpers, bedrock_client, etc.)
    compatibleRuntimes:
      - python3.13
    retain: false
  kbSharedCode:
    path: layers/kb
    name: ${self:service}-${self:provider.stage}-kb-shared-code
    description: Knowledge Base specific shared code (kb_repositories, faiss_utils, document_processing, dynamic_bedrock)
    compatibleRuntimes:
      - python3.13
    retain: false

package:
  individually: true
  patterns:
    - "!.venv/**"
    - "!venv/**"
    - "!node_modules/**"
    - "!tests/**"
    - "!__pycache__/**"
    - "!*.pyc"
    - "!.pytest_cache/**"
    - "!.serverless/**"
    - "!package.json"
    - "!package-lock.json"
    - "!serverless.yml"
    - "!.python-version"
    - "!.git/**"
    - "!layers/**"
    - "!lambdas/**" # Exclude all lambdas by default
    - "!lambdas/shared/**"
    - "!*.md"
    - "!*.sh"
    - "!*.log"
    - "!*.txt"
    - "!*.json"
    - "!numpy/**"
    - "!numpy-*/**"
    - "!faiss/**"
    - "!faiss-*/**"

functions:
  # File Processing API
  generateFileUploadUrl:
    handler: lambdas/file_processing.generate_upload_url
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/upload-url
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  listOutputFiles:
    handler: lambdas/file_processing.list_output_files
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/outputs
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  listAvailableSheets:
    handler: lambdas/file_processing.list_available_sheets
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/sheets
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  getEstimate:
    handler: lambdas/file_processing.get_estimate
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/estimate/{filename}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  checkFileExists:
    handler: lambdas/file_processing.check_file_exists
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/check/{filepath+}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  listActiveJobs:
    handler: lambdas/file_processing.list_active_jobs
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/active-jobs
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  deleteEstimate:
    handler: lambdas/file_processing.delete_estimate
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/estimate/{filename}
          method: delete
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  checkTaskStatus:
    handler: lambdas/file_processing.check_task_status
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/task-status
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  onTaskStopped:
    handler: lambdas/file_processing.on_task_stopped
    environment:
      FILE_PROCESSING_BUCKET: ${self:provider.environment.FILE_PROCESSING_BUCKET}
    events:
      - eventBridge:
          pattern:
            source:
              - aws.ecs
            detail-type:
              - ECS Task State Change
            detail:
              lastStatus:
                - STOPPED
              clusterArn:
                - prefix: arn:aws:ecs:${aws:region}:${aws:accountId}:cluster/AlmabaniStack-AlmabaniCluster

  checkJobStatus:
    handler: lambdas/file_processing.check_job_status
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/file_processing.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /files/job-status/{filename}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}


  healthCheck:
    handler: lambdas/user_profile.health_check
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/user_profile.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /health
          method: get
          cors: true

  getUserProfile:
    handler: lambdas/user_profile.get_user_profile
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/user_profile.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /profile
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  updateUserProfile:
    handler: lambdas/user_profile.update_user_profile
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/user_profile.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /profile
          method: put
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  createItem:
    handler: lambdas/items.create_item
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/items.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /items
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  getUserItems:
    handler: lambdas/items.get_user_items
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/items.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /items
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  updateItem:
    handler: lambdas/items.update_item
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/items.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /items/{itemId}
          method: put
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  deleteItem:
    handler: lambdas/items.delete_item
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/items.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /items/{itemId}
          method: delete
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  listKnowledgeBases:
    handler: lambdas/knowledge_bases.list_knowledge_bases
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/knowledge_bases.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  createKnowledgeBase:
    handler: lambdas/knowledge_bases.create_knowledge_base
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/knowledge_bases.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  getKnowledgeBase:
    handler: lambdas/knowledge_bases.get_knowledge_base
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/knowledge_bases.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  updateKnowledgeBase:
    handler: lambdas/knowledge_bases.update_knowledge_base
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/knowledge_bases.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}
          method: put
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  deleteKnowledgeBase:
    handler: lambdas/knowledge_bases.delete_knowledge_base
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/knowledge_bases.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}
          method: delete
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  generateKnowledgeBaseUploadUrl:
    handler: lambdas/kb_documents.generate_upload_url
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/kb_documents.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}/upload-url
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  confirmKnowledgeBaseDocument:
    handler: lambdas/kb_documents.confirm_document_upload
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/kb_documents.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}/documents
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  listKnowledgeBaseDocuments:
    handler: lambdas/kb_documents.list_documents
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/kb_documents.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}/documents
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  deleteKnowledgeBaseDocument:
    handler: lambdas/kb_documents.delete_document
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/kb_documents.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}/documents/{documentId}
          method: delete
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  queryKnowledgeBase:
    handler: lambdas/kb_query.query_knowledge_base
    timeout: 30
    memorySize: 3008
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/kb_query.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - http:
          path: /knowledge-bases/{kbId}/query
          method: post
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  knowledgeBaseIndexingWorker:
    handler: lambdas/kb_indexing_worker.handler
    timeout: 900
    memorySize: 3008
    ephemeralStorageSize: 10240
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/kb_indexing_worker.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    events:
      - sqs:
          arn:
            Fn::GetAtt:
              - KnowledgeBaseIndexingQueue
              - Arn
          batchSize: 1

  workflowWorker:
    handler: lambdas/workflow_worker.handler
    timeout: 300
    memorySize: 1024
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/workflow_worker.py"
        - "lambdas/__init__.py"
        - "lambdas/handlers/**"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    environment:
      CONVERSATIONS_TABLE: ${self:service}-${self:provider.stage}-conversations
      KB_TABLE_NAME: ${self:service}-${self:provider.stage}-knowledge-bases
      DOCS_TABLE_NAME: ${self:service}-${self:provider.stage}-documents
      KB_BUCKET_NAME: ${self:service}-${self:provider.stage}-kb
      REPORTS_TABLE: ${self:service}-${self:provider.stage}-reports

  # Configuration API
  getConfig:
    handler: lambdas/config_handler.get_config
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/config_handler.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /config/{type}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  updateConfig:
    handler: lambdas/config_handler.update_config
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/config_handler.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /config/{type}
          method: put
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  listReports:
    handler: lambdas/reports_handler.list_reports
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/reports_handler.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /reports
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}

  getReport:
    handler: lambdas/reports_handler.get_report
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/reports_handler.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    events:
      - http:
          path: /reports/{id}
          method: get
          cors: true
          authorizer:
            name: cognitoAuthorizer
            type: COGNITO_USER_POOLS
            arn: ${env:COGNITO_USER_POOL_ARN}



  # H&S + Quality Workflow Functions
  twilioWebhook:
    handler: lambdas/twilio_webhook.handler
    timeout: 30
    memorySize: 128
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/twilio_webhook.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
    environment:
      WORKFLOW_FUNCTION_NAME: ${self:service}-${self:provider.stage}-workflowWorker

      # KNOWLEDGE_BASE_ID: "YOUR_KB_ID" # TODO: Update with actual KB ID after deployment or pass as env var
    events:
      - http:
          path: /webhook/twilio
          method: post
          cors: false

  reportProcessor:
    handler: lambdas/report_processor.handler
    timeout: 300
    memorySize: 1024
    package:
      patterns:
        - "!.venv/**"
        - "!venv/**"
        - "!node_modules/**"
        - "!tests/**"
        - "!__pycache__/**"
        - "!*.pyc"
        - "!.pytest_cache/**"
        - "!.serverless/**"
        - "!package.json"
        - "!package-lock.json"
        - "!serverless.yml"
        - "!.python-version"
        - "!.git/**"
        - "!layers/**"
        - "!*.md"
        - "!*.sh"
        - "!*.log"
        - "!*.txt"
        - "!*.json"
        - "!numpy/**"
        - "!numpy-*/**"
        - "!faiss/**"
        - "!faiss-*/**"
        - "lambdas/report_processor.py"
        - "lambdas/__init__.py"
    layers:
      - { Ref: PythonRequirementsLambdaLayer }
      - { Ref: SharedCodeLambdaLayer }
      - { Ref: KbSharedCodeLambdaLayer }
    environment:
      REPORTS_TABLE: ${self:service}-${self:provider.stage}-reports
      USER_PROJECT_TABLE: ${self:service}-${self:provider.stage}-user-projects
      REPORTS_BUCKET: ${self:service}-${self:provider.stage}-reports

resources:
  Resources:
    DynamoDBTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-table
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # Reports Table
    ReportsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-reports
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # User-Project Mappings Table
    UserProjectTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-user-projects
        AttributeDefinitions:
          - AttributeName: phoneNumber
            AttributeType: S
        KeySchema:
          - AttributeName: phoneNumber
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    # S3 Bucket for Reports
    ReportsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-${self:provider.stage}-reports
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: ArchiveOldImages
              Status: Enabled
              Transitions:
                - TransitionInDays: 90
                  StorageClass: STANDARD_IA
                - TransitionInDays: 365
                  StorageClass: GLACIER
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    ReportsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket:
          Ref: ReportsBucket
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Principal: "*"
              Action: "s3:GetObject"
              Resource:
                Fn::Join:
                  - ""
                  - - "arn:aws:s3:::"
                    - Ref: ReportsBucket
                    - "/*"

    KnowledgeBasesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-knowledge-bases
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: kbId
            AttributeType: S
          - AttributeName: createdAt
            AttributeType: N
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: kbId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: KbIdIndex
            KeySchema:
              - AttributeName: kbId
                KeyType: HASH
              - AttributeName: userId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: UserCreatedAtIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
              - AttributeName: createdAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    DocumentsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-documents
        AttributeDefinitions:
          - AttributeName: kbId
            AttributeType: S
          - AttributeName: documentId
            AttributeType: S
          - AttributeName: uploadedAt
            AttributeType: N
        KeySchema:
          - AttributeName: kbId
            KeyType: HASH
          - AttributeName: documentId
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: KbUploadedAtIndex
            KeySchema:
              - AttributeName: kbId
                KeyType: HASH
              - AttributeName: uploadedAt
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        BillingMode: PAY_PER_REQUEST
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    KnowledgeBaseBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-${self:provider.stage}-kb
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        VersioningConfiguration:
          Status: Enabled
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - POST
                - HEAD
              AllowedOrigins:
                - "*"
              ExposedHeaders:
                - ETag
                - x-amz-server-side-encryption
                - x-amz-request-id
                - x-amz-id-2
              MaxAge: 3000
        LifecycleConfiguration:
          Rules:
            - Id: ExpireTempArtifacts
              Status: Enabled
              ExpirationInDays: 365
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

    KnowledgeBaseIndexingDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-kb-indexing-dlq
        MessageRetentionPeriod: 1209600

    KnowledgeBaseIndexingQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-${self:provider.stage}-kb-indexing
        VisibilityTimeout: 900
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt:
              - KnowledgeBaseIndexingDLQ
              - Arn
          maxReceiveCount: 3

    # Conversations Table for State Management
    ConversationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-${self:provider.stage}-conversations
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: expiresAt
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: ${self:service}

  Outputs:
    ApiGatewayRestApiId:
      Value:
        Ref: ApiGatewayRestApi
      Export:
        Name: ${self:service}-${self:provider.stage}-api-id
    ApiGatewayRestApiRootResourceId:
      Value:
        Fn::GetAtt:
          - ApiGatewayRestApi
          - RootResourceId
      Export:
        Name: ${self:service}-${self:provider.stage}-api-root-resource-id
    DynamoDBTableName:
      Value:
        Ref: DynamoDBTable
      Export:
        Name: ${self:service}-${self:provider.stage}-table-name
    ReportsTableName:
      Value:
        Ref: ReportsTable
      Export:
        Name: ${self:service}-${self:provider.stage}-reports-table-name
    ReportsBucketName:
      Value:
        Ref: ReportsBucket
      Export:
        Name: ${self:service}-${self:provider.stage}-reports-bucket-name
    TwilioWebhookUrl:
      Value:
        Fn::Sub: "https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}/webhook/twilio"
      Export:
        Name: ${self:service}-${self:provider.stage}-twilio-webhook-url
